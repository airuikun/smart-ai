{"version":3,"file":"index.js","sources":["../src/index.tsx"],"sourcesContent":["import React, { RefObject } from 'react';\nimport Vue from 'vue';\nimport { mountRootParcel, ParcelConfig } from 'single-spa';\nimport singleSpaVue from 'single-spa-vue';\nimport uniqueId from 'lodash/uniqueId';\n\nconst __VUE_INTERNAL_INIT__ = Vue.prototype._init;\nVue.prototype._init = function(options: any) {\n  /**\n   * TODO: 留个口儿 用来以后支持加载整个Vue应用\n   */\n  __VUE_INTERNAL_INIT__.call(this, options);\n};\n\ninterface Self {\n  Vue: typeof Vue;\n  [ propName: string ]: any;\n}\n\ninterface IProps0 {\n  cssurl?: string;\n  name?: string;\n  id?: string;\n  visible?: boolean;\n  extraProps?: { [propName: string]: any };\n  loadType?: 'xhr' | 'script';\n  instable_publicPath?: string;\n}\n\ninterface IProps1 extends IProps0 {\n  jsurl: string;\n  component?: object;\n}\n\ninterface IProps2 extends IProps0 {\n  component: object;\n  jsurl?: string; \n}\n\ntype IProps = IProps1 | IProps2;\ntype RefType = RefObject<HTMLDivElement>;\n\n\ninterface ISelecotr {\n  'getElementById': NonElementParentNode;\n  'querySelector': ParentNode;\n  'querySelectorAll': ParentNode;\n}\n\n/**\n * toolFunction()的时候会返回一个boolean 表示当前是否有vue代码正在运行\n * toolFunction(-1)的时候会返回所有的ele\n * toolFunction(element)的时候表示这个元素对应的vue组件代码正在运行\n * toolFunction(number)的时候表示要获取这个id对应的element\n * toolFunction(number, false)表示把这个id对应的状态设置为false\n * toolFunction(number, -1)表示把这个id对应的删除并返回是否所有的都unmount了\n * \n * 1. 啥也不传返回obj里所有属性对应的对象的status属性是否起码有一个为true\n * 2. 只传一个参数并且是-1的时候把所有的ele返回\n * 3. 只传一个参数并且是divElement的话就往obj添加一个对象同时返回runId\n * 4. 只传一个参数并且是number类型的话, 就返回这个runId对应divElement\n * 5. 传俩参数并且第一个是number, 第二个是false的话就把这个id对应的对象status改为false\n * 6. 传进来俩参数第一个是number, 第二个是-1的话, 就把这个id对应的删除\n */\nconst toolFunction = ((\n  obj: { [prop: string]: { running: boolean; ele: HTMLDivElement } },\n  id: number,\n) => {\n  return function(a?: number | HTMLDivElement, b?: HTMLDivElement | false | -1):\n    boolean |\n    HTMLDivElement |\n    HTMLDivElement[] |\n    number \n  {\n    const length = arguments.length;\n    if (!length) {\n      if (!Object.keys(obj).length) return false;\n      return Object.values(obj).some(item => item.running);\n    } else if (length === 1 && a === -1) {\n      return Object.values(obj).map(item => item.ele);\n    } else if (length === 1 && a instanceof HTMLElement) {\n      obj[id++] = { running: true, ele: a };\n      return id - 1;\n    } else if (length === 1 && typeof a === 'number') {\n      return obj[a].ele;\n    } else if (length === 2 && typeof a === 'number' && b === false) {\n      obj[a].running = false;\n      return obj[a].ele;\n    } else if (length === 2 && typeof a === 'number' && b === -1) {\n      delete obj[a];\n      return !Object.keys(obj).length;\n    }\n    throw Error('传参有问题');\n  }\n})({}, 0);\n\nconst getWrapper = ((obj: { [ name: string ]: HTMLDivElement }) => {\n  return (name: string, ele?: HTMLDivElement) => {\n    if (name && ele) (obj[name] = ele)\n    else if (name && !ele) return obj[name];\n  }\n})({});\n\nconst originSelectors = HTMLDocument.prototype as any;\nconst initHackSelector = (\n  name: keyof ISelecotr,\n  originSelectorFn:\n    Document['getElementById'] |\n    ParentNode['querySelector'] |\n    ParentNode['querySelectorAll']\n) => {\n  return (cancelHack?: boolean) => {\n    const HTMLDocumentPrototype = (HTMLDocument.prototype as any);\n    if (cancelHack) return (HTMLDocumentPrototype[name] = originSelectorFn);\n    HTMLDocumentPrototype[name] = function <E extends Element = Element>(id: string):\n      HTMLElement | null | NodeListOf<E> {\n      const originEl = (originSelectorFn as Function).call(this, id);\n      if (originEl) return originEl;\n      if (!originEl) {\n        const allShadowRoot = toolFunction(-1) as HTMLDivElement[];\n        const len = allShadowRoot.length;\n        for (let i = 0; i < len; i++) {\n          const wrapper = allShadowRoot[i];\n          const shadowEl = wrapper &&\n            wrapper.shadowRoot &&\n            wrapper.shadowRoot[name] &&\n            typeof wrapper.shadowRoot[name] === 'function' &&\n            (wrapper.shadowRoot as any)[name](id) as HTMLElement | null | NodeListOf<E>;\n          if (shadowEl) return shadowEl;\n        }\n      }\n      return null;\n    }\n  };\n}\n\nconst originModule = window.module;\nconst originRequire = window.require;\nconst originExports = window.exports;\nconst selectorMap = {\n  'getElementById': initHackSelector('getElementById', originSelectors['getElementById']),\n  'querySelector': initHackSelector('querySelector', originSelectors['querySelector']),\n  'querySelectorAll': initHackSelector('querySelectorAll', originSelectors['querySelectorAll']),\n};\nselectorMap.getElementById();\nselectorMap.querySelector();\nselectorMap.querySelectorAll();\n\nconst originAppendChild = HTMLHeadElement.prototype.appendChild;\nconst LINK_TAG_NAME = 'LINK';\nconst STYLE_TAG_NAME = 'STYLE';\n\nHTMLHeadElement.prototype.appendChild = function <T extends Node>(this: any, newChild: T) {\n  const element = newChild as any;\n  if (element.tagName) {\n    switch (element.tagName) {\n      case LINK_TAG_NAME:\n      case STYLE_TAG_NAME: {\n        const currentScript = document.currentScript;\n        /** 获取到currentName */\n        const currentName = currentScript?.getAttribute('data-id');\n        if (!currentName) return originAppendChild.call(this, element) as T;\n        setTimeout(() => {\n          getWrapper(currentName)?.shadowRoot?.appendChild(element);\n        })\n        return originAppendChild.call(this, element.cloneNode()) as T;\n      }\n    }\n  }\n  return originAppendChild.call(this, element) as T;\n};\n\nconst httpReg = new RegExp(\"^https?://[\\\\w-.]+(:\\\\d+)?\", 'i');\n\nexport default class VueIframe extends React.PureComponent<IProps, {}> {\n  private loadType: IProps['loadType']; // 加载方式 支持ajax和script标签\n  private currentName: string; // 每个iframe的name\n  private visible: boolean; // 是否显示\n  private currentUrl: string; // 传进来的url\n  private currentCSSUrl: string; // 传进来的cssurl\n  private currentPublicPath: string; // 传进来的url的协议+域名+端口\n  private publicPathKey: string; // 远程源代码中要被替换的关键字\n  private publicPathReg: RegExp; // 用来替换源代码中关键字的正则\n  private rootNodeWrapper: RefType = React.createRef<HTMLDivElement>(); // vue挂载节点是根据el再往上找它的爹\n  private component: any; // vue 组件实例\n  private parcel: any; // parcel实例\n  private vueWrapper1: HTMLDivElement = document.createElement('div'); // 挂载vue以及隐藏vue需要两个节点\n  private vueWrapper2: HTMLDivElement = document.createElement('div'); // 真正vue需要挂载的节点\n  private styleElements: HTMLLinkElement[] | HTMLStyleElement[] = []; // 用来临时存放要被添加的style标签\n  private runId: number = -1; // 当前正在跑的vue组件的runId 唯一\n\n  constructor(props: IProps) {\n    super(props);\n    const { loadType, jsurl = '', cssurl, component, name, visible, instable_publicPath } = props;\n    const unique = uniqueId();\n    this.loadType = loadType || 'script';\n    // 初始化时候是否显示\n    this.visible = typeof visible === 'boolean' ? visible : true;\n    // 获取到外部传进来的vue组件\n    this.component = component;\n    // 获取到外部传来的url\n    this.currentUrl = jsurl || '';\n    // 获取外部传进来的css的url 可能没有\n    this.currentCSSUrl = cssurl || '';\n    // 这个属性是用来标识要替换远程源代码中的publicPath的关键字\n    this.publicPathKey = instable_publicPath || '__WILL_BE_REPLACED_PUBLIC_PATH__';\n    // 这个正则会用来把远程源码中的__webpack_require__.p = 'xxxxx' 的xxxxx这个publiPath给替换掉\n    this.publicPathReg = new RegExp(this.publicPathKey, 'g');\n    // 生成每个iframe的唯一表示\n    this.currentName = name || `${jsurl.replace(httpReg, '')}.${unique}`|| `vue-root-${unique}`;\n    // 获取传进来的url的协议+域名+端口\n    this.currentPublicPath = `${(httpReg.exec(this.currentUrl) || [''])[0]}/`;\n    // vue会挂载到这个节点2上\n    this.vueWrapper2.id = this.currentName;\n    // 把wrapper暂时存到外头\n    getWrapper(this.currentName, this.vueWrapper1);\n  }\n\n  componentDidMount = async () => {\n    if (!this.currentUrl && !this.component) throw Error('组件必须接收一个url或者component属性');\n    const rootEleWrapper = this.rootNodeWrapper.current;\n    if (!rootEleWrapper) throw Error('没有vue组件的root节点');\n    /** 如果外部传了component就随机起个name */\n    const component = this.props.component || await this.getOriginVueComponent();\n    if (!this.isVueComponent(component)) return;\n    this.registerComponentAndMount(component);\n    this.addComponentToPage(rootEleWrapper);\n  }\n\n  componentDidUpdate = () => {\n    const { visible = true } = this.props; \n    if (visible === this.visible) return;\n    this.visible = visible;\n    const rootNodeWrapper = this.rootNodeWrapper.current;\n    if (!visible) {\n      this.vueWrapper1 = rootNodeWrapper?.removeChild(this.vueWrapper1) as HTMLDivElement;\n    } else {\n      rootNodeWrapper?.appendChild(this.vueWrapper1);\n    }\n  }\n\n  /**\n   * componentWillUnmount被调用时候不一定就是出错\n   * 但是贸然地在react项目中挂载vue组件可能出现问题\n   * 当出现问题的时候react组件会被卸载 此时会调用componentWillUnmount\n   * 这个时候应该确认下项目是否还正常运行(八成报错)\n   */\n  componentWillUnmount = () => {\n    (this.rootNodeWrapper.current as any).removeChild(this.vueWrapper1);\n    this.parcel.unmount();\n    this.parcel = null;\n    const allUnmount = toolFunction(this.runId, -1);\n    if (allUnmount) {\n      selectorMap.getElementById(false);\n      selectorMap.querySelector(false);\n      selectorMap.querySelectorAll(false);\n      HTMLHeadElement.prototype.appendChild = originAppendChild;\n    }\n    (this.vueWrapper1 as any) = null;\n    (this.vueWrapper2 as any) = null;\n    (this.rootNodeWrapper as any) = null;\n    (this.styleElements as any) = [];\n  }\n\n  private registerComponentAndMount = (component: object): void => {\n    const lifecycles = this.registerVueComponent(this.vueWrapper2, component, this.currentName);\n    this.parcel = mountRootParcel((lifecycles as ParcelConfig), { domElement: '-' });\n  }\n\n  private addComponentToPage = (rootEleWrapper: HTMLDivElement): void => {\n    /** 如果visible是false就暂时先把display置为none 之后再remove */\n    if (!this.visible) this.vueWrapper1.style.display = 'none';\n    const supportShadowDOM = !!this.vueWrapper1.attachShadow;\n    const root = supportShadowDOM ? (\n      (this.vueWrapper1.attachShadow({ mode: 'open' })) &&\n      this.vueWrapper1.shadowRoot\n    ) : this.vueWrapper1;\n    const cssurl = this.currentCSSUrl;\n    if (cssurl) {\n      const oLink = document.createElement('link');\n      oLink.rel = \"stylesheet\";\n      oLink.href = cssurl;\n      root?.appendChild(oLink);\n    }\n\n    this.styleElements.forEach(style => {\n      root?.appendChild(style);\n    });\n    root?.appendChild(this.vueWrapper2);\n    rootEleWrapper.appendChild(this.vueWrapper1);\n    setTimeout(() => {\n      /**\n       * 对于一上来visible就是不可见的组件\n       * 先把display置为none 然后再添加进页面\n       * 这是为了防止vue组件中可能会有类似echarts\n       * 之类的工具会通过document.querySelector等\n       * 方法选择dom\n       * 如果直接就不把vue组件添加进页面的话\n       * vue组件内部那些选择dom的方法可能会产生问题\n       */\n      if (!this.visible) {\n        this.vueWrapper1 = rootEleWrapper?.removeChild(this.vueWrapper1) as HTMLDivElement;\n      }\n      this.vueWrapper1.style.display = 'block';\n    });\n  }\n\n  private registerVueComponent = (el: string | HTMLElement, vueComponent: object, id: string) => {\n    const vueInstance = singleSpaVue({\n      Vue,\n      appOptions: {\n        el: typeof el === 'string' ? `#${el}` : el,\n        render: (h: any) => h('div', { attrs: { id } }, [h(vueComponent, {\n          props: { ...this.props.extraProps },\n        })]),\n      },\n    });\n    return ({\n      bootstrap: vueInstance.bootstrap,\n      mount: vueInstance.mount,\n      unmount: vueInstance.unmount,\n    })\n  }\n\n  private isVueComponent = (component: any): boolean => {\n    return component && typeof component === 'object' && typeof component.render === 'function';\n  }\n\n  private getOriginCode = (url: string, method: string = 'GET', data?: any): Promise<any> => {\n    return new Promise((res, rej) => {\n      const xhr: XMLHttpRequest = XMLHttpRequest ? new XMLHttpRequest() :\n        ActiveXObject ? new ActiveXObject('Microsoft.XMLHTTP') : null;\n      if (method === 'GET' && data) data && (url += `?${data}`);\n      xhr.open(method, url, true);\n      if (method == 'GET') {\n        xhr.send();\n      } else {\n        xhr.setRequestHeader('content-type', 'text/plain');\n        xhr.send((data as (Document | BodyInit | null)));\n      }\n      xhr.onreadystatechange = () => {\n        if (xhr.readyState === 4) {\n          if (xhr.status === 200) res(xhr.responseText);\n          else rej(xhr);\n        }      \n      }\n    });\n  }\n\n  private executeOriginCode = (code: string): Self => {\n    const internalSelf: Self = { Vue };\n    const reg = this.publicPathReg;\n    const publicPath = this.currentPublicPath;\n    const url = this.currentUrl;\n    if (reg.test(code)) {\n      /**\n       * 自己开发组件的时候使用可以配置publicPath\n       * 为了让react-vue-mirco-frame支持加载静态资源\n       * 可以给publicPath设置为一个约定好的值\n       * 然后这里用传进来的origin替换掉这个约定好的值\n       * 这个约定好的值默认是 __WILL_BE_REPLACED_PUBLIC_PATH__\n       */\n      const codeStr = code.replace(reg, publicPath);\n      const originCodeFn = new Function(\"self\", codeStr);\n      originCodeFn(internalSelf);\n    } else {\n      /**\n       * 如果没有配置这个值的话 就以hack的方式注入origin\n       * webpack打包出来的umd代码里面会动态监测document.currentScript\n       * 通过临时给这个currentScript换掉的方式让webpack将origin注入进代码\n       */\n      const temporaryDocument = (window.document as any);\n      const originCurrentScript = window.document.currentScript;\n      const temporaryScript = document.createElement('script');\n      const defineProperty = Object.defineProperty;\n      temporaryScript.src = url;\n      defineProperty(temporaryDocument, 'currentScript', {\n        value: temporaryScript,\n        writable: true,\n      });\n      const originCodeFn = new Function(\"self\", code);\n      originCodeFn(internalSelf);\n      defineProperty(temporaryDocument, 'currentScript', {\n        value: originCurrentScript,\n        writable: false,\n      });\n      temporaryScript.remove && temporaryScript.remove();\n    };\n    return internalSelf;\n  } \n\n  private getOriginVueComponent = (): object => {\n    if (this.loadType === 'script') {\n      return new Promise(res => {\n        const oScript = document.createElement('script');\n        oScript.type = 'text/javascript';\n        oScript.src = this.currentUrl;\n        oScript.setAttribute('data-id', this.currentName);\n        document.body.appendChild(oScript);\n        const runId = this.runId = toolFunction(this.vueWrapper1) as number;\n        (window as any).module = {};\n        (window as any).require = (str: string) => (str === 'vue') && Vue;\n        window.exports = null;\n        oScript.onload = () => {\n          this.component = window.module.exports;\n          toolFunction(runId, false);\n          if (!toolFunction()) {\n            window.module = originModule;\n            window.require = originRequire;\n            window.exports = originExports;\n          }\n          /**\n           * 这里留个口可以用来以后支持esm规范的组件\n           * const temporaryExports = window.exports;\n           * let component = null;\n           * for (const propName in temporaryExports) {\n           * if (!temporaryExports.hasOwnProperty(propName)) continue;\n           *   component = temporaryExports[propName]\n           *   delete temporaryExports[propName];\n           * }\n           */\n          oScript.remove();\n          res(this.component);\n        };\n      });\n    } else {\n      console.warn('暂时关闭xhr的加载方式, 将使用script方式加载')\n      this.loadType = 'script';\n      return new Promise(res => res(this.getOriginVueComponent()));\n      // return new Promise(res => {\n      //   this.getOriginCode(this.currentUrl).then(data => {\n      //     /** 通过XMLHttpRequest获取源代码 */\n      //     if (!data || typeof data !== 'string') throw Error('没有加载到远程vue组件');\n      //     const internalSelf = this.executeOriginCode(data);\n      //     if (!this.currentName) (this.currentName = this.getCurrentName(internalSelf));\n      //     if (!this.currentName) throw Error('没有获取到vue组件');\n      //     this.vueWrapper2.id = this.currentName;\n      //     this.component = internalSelf[this.currentName];\n      //     res(this.component);\n      //   }).catch(err => {\n      //     /** 如果进入到这里说明可能请求出错了 */\n      //     console.warn('远程vue组件请求可能出现跨域或其他网络问题');\n      //     /** 如果出现跨域问题就强制使用script方式加载一遍 */\n      //     this.loadType = 'script';\n      //     res(this.getOriginVueComponent());\n      //   });\n      // });\n    } \n  }\n\n  render = () => (<div id={this.props.id || ''} ref={this.rootNodeWrapper} />)\n}\n"],"names":["__VUE_INTERNAL_INIT__","Vue","prototype","_init","options","call","toolFunction","obj","id","a","b","length","arguments","Object","keys","values","some","item","running","map","ele","HTMLElement","Error","getWrapper","name","originSelectors","HTMLDocument","initHackSelector","originSelectorFn","cancelHack","HTMLDocumentPrototype","originEl","allShadowRoot","len","i","wrapper","shadowEl","shadowRoot","originModule","window","module","originRequire","require","originExports","exports","selectorMap","getElementById","querySelector","querySelectorAll","originAppendChild","HTMLHeadElement","appendChild","LINK_TAG_NAME","STYLE_TAG_NAME","newChild","element","tagName","currentScript","document","currentName_1","getAttribute","setTimeout","cloneNode","httpReg","RegExp","__extends","props","_super","_this","React","createRef","createElement","currentUrl","component","rootEleWrapper","rootNodeWrapper","current","_a","getOriginVueComponent","_b","isVueComponent","registerComponentAndMount","addComponentToPage","_c","visible","vueWrapper1","removeChild","parcel","unmount","allUnmount","runId","vueWrapper2","styleElements","lifecycles","registerVueComponent","currentName","mountRootParcel","domElement","style","display","supportShadowDOM","attachShadow","root","mode","cssurl","currentCSSUrl","oLink","rel","href","forEach","el","vueComponent","vueInstance","singleSpaVue","appOptions","render","h","attrs","extraProps","bootstrap","mount","url","method","data","Promise","res","rej","xhr","XMLHttpRequest","ActiveXObject","open","send","setRequestHeader","onreadystatechange","readyState","status","responseText","code","internalSelf","reg","publicPathReg","publicPath","currentPublicPath","test","codeStr","replace","originCodeFn","Function","temporaryDocument","originCurrentScript","temporaryScript","defineProperty","src","value","writable","remove","loadType","oScript","type","setAttribute","body","str","onload","console","warn","ref","jsurl","instable_publicPath","unique","uniqueId","publicPathKey","exec","PureComponent"],"mappings":"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"}