{"version":3,"file":"index.js","sources":["../src/index.tsx"],"sourcesContent":["import React from 'react';\nimport Vue from 'vue';\nimport { registerApplication, start, LifeCycles } from 'single-spa';\nimport singleSpaVue from 'single-spa-vue';\nimport axios from 'axios';\n\nconst __VUE_INTERNAL_INIT__ = Vue.prototype._init;\nVue.prototype._init = function(options: any) {\n  /**\n   * TODO: 留个口儿 用来以后支持加载整个Vue应用(目前只支持加载组件)\n   */\n  __VUE_INTERNAL_INIT__.call(this, options);\n};\n\ninterface IProps {\n  name: string | number;\n  activation: boolean;\n  url: string;\n  extraProps?: { [propName: string]: any };\n  publicPathWillBeReplacedKeyWord?: string;\n}\n\nexport default class VueIframe extends React.Component<IProps, any> {\n  private currentName: string; // 每个iframe的唯一标识\n  private isMount: boolean = false; // 是否挂载\n  private currentUrl: string; // 传进来的url\n  private currentPublicPath: string; // 传进来的url的协议+域名+端口\n  private publicPathKey: string; // 远程源代码中要被替换的关键字\n  private publicPathReg: RegExp; // 用来替换源代码中关键字的正则\n  private rootNode: HTMLDivElement = document.createElement('div'); // vue组件挂载的root\n  private rootNodeWrapper = React.createRef<HTMLDivElement>(); // vue挂载节点是根据el再往上找它的爹\n\n  private test: any;\n  constructor(props: IProps) {\n    super(props);\n    const { url, publicPathWillBeReplacedKeyWord } = props;\n    // 获取到外部传来的url\n    this.currentUrl = url;\n    // 这个属性是用来标识要替换远程源代码中的publicPath的关键字\n    this.publicPathKey = publicPathWillBeReplacedKeyWord || '__WILL_BE_REPLACED_PUBLIC_PATH__';\n    // 这个正则会用来把远程源码中的__webpack_require__.p = 'xxxxx' 的xxxxx这个publiPath给替换掉\n    this.publicPathReg = new RegExp(this.publicPathKey, 'g');\n    // 生成每个iframe的唯一表示\n    this.currentName = String(props.name || +new Date());\n    // 获取传进来的url的协议+域名+端口\n    this.currentPublicPath = `${(\n      new RegExp(\"^https?://[\\\\w-.]+(:\\\\d+)?\", 'i').exec(this.currentUrl) || ['']\n    )[0]}/`;\n    // 设置一个内部的挂载节点\n    this.rootNode.id = this.currentName;\n  }\n\n  private registerVueComponent = (id: string, vueComponent: Object) => {\n    const vueInstance = singleSpaVue({\n      Vue,\n      appOptions: {\n        el: `#${id}`,\n        render: (h: any) => h('div', { attrs: { id } }, [h(vueComponent, {\n          props: { ...this.props.extraProps }\n        })])\n      }\n    });\n    return ({\n      bootstrap: vueInstance.bootstrap,\n      mount: vueInstance.mount,\n      unmount: vueInstance.unmount,\n    })\n  }\n\n  private getBoolean: () => boolean = () => this.isMount;\n\n  private mount = () => (this.isMount = true) && start();\n\n  private unmount = () => (this.isMount = false) || start();\n\n  componentDidUpdate = () => this.props.activation ? this.mount() : this.unmount();\n\n  /**\n   * componentWillUnmount被调用时候不一定就是出错\n   * 但是贸然地在react项目中挂载vue组件可能出现问题\n   * 当出现问题的时候react组件会被卸载 此时会调用componentWillUnmount\n   * 这个时候应该确认下项目是否还正常运行(八成报错)\n   */\n  componentWillUnmount = () => this.rootNodeWrapper.current?.removeChild(this.rootNode);\n  \n  componentDidMount = () => {\n    registerApplication(\n      this.currentName, \n      (): Promise<LifeCycles<{}>> => {\n        return new Promise(resolve => {\n          axios.get(this.currentUrl).then(({ data }) => {\n            if (!data) throw Error('没有加载到远程vue组件');\n            /**\n             * 这里由于自定义了webpack中的self\n             * 所以需要给这个self里头传递一个Vue对象\n             */\n            const internalSelf: any = { Vue };\n            const rootEleWrapper = this.rootNodeWrapper.current;\n            if (!rootEleWrapper) throw Error('没有vue组件的root节点');\n            /**\n             * 直接在react渲染的节点下渲染vue组件会发生严重错误\n             * 具体错误原因暂时未知\n             * 所以需要手动创建一个节点后插入\n             */\n            rootEleWrapper.appendChild(this.rootNode);\n            /**\n             * 这里用传进来的url的origin替换掉源代码中webpack生成的publicPath\n             * 否则的话一般vue打包出来的组件的publicPath都是 '/'\n             * 直接在这里执行的话就会默认指向当前域然后会404\n             * 所以这里希望组件开发的时候将publicPath设置为一个约定好的key\n             * 这里用真正的远程路径替换\n             */\n            const codeStr = (data || '').replace(this.publicPathReg, this.currentPublicPath);\n            const originCodeFn = new Function(\"self\", codeStr);\n            originCodeFn(internalSelf);\n            const currentComponent = internalSelf[this.currentName];\n            const lifecycles = this.registerVueComponent(this.currentName, currentComponent);\n            resolve(lifecycles);\n          })\n        })\n      },\n      this.getBoolean,\n    );\n    if (this.props.activation) this.mount();\n  }\n\n  render = () => (<div ref={this.rootNodeWrapper} />)\n}\n"],"names":["__VUE_INTERNAL_INIT__","Vue","prototype","_init","options","call","__extends","props","_super","_this","document","createElement","React","createRef","id","vueComponent","vueInstance","singleSpaVue","appOptions","el","render","h","attrs","extraProps","bootstrap","mount","unmount","isMount","start","activation","rootNodeWrapper","current","removeChild","rootNode","registerApplication","currentName","Promise","resolve","axios","get","currentUrl","then","_a","data","Error","internalSelf","rootEleWrapper","appendChild","codeStr","replace","publicPathReg","currentPublicPath","originCodeFn","Function","currentComponent","lifecycles","registerVueComponent","getBoolean","ref","url","publicPathWillBeReplacedKeyWord","publicPathKey","RegExp","String","name","Date","exec","Component"],"mappings":"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"}