{"version":3,"file":"index.js","sources":["../src/index.tsx"],"sourcesContent":["import React from 'react';\nimport Vue from 'vue';\nimport { registerApplication, start, LifeCycles } from 'single-spa';\nimport singleSpaVue from 'single-spa-vue';\nimport axios from 'axios';\n\nconst registerVueComponent = (id: string, vueComponent: Object) => {\n  const vueInstance = singleSpaVue({ \n    Vue,\n    appOptions: {\n      el: `#${id}`, \n      render: (h: any) => h('div', { attrs: { id } }, [h(vueComponent)])\n    }\n  });\n  return ({\n    bootstrap: vueInstance.bootstrap,\n    mount: vueInstance.mount,\n    unmount: vueInstance.unmount,\n  })\n}\n\ninterface IProps {\n  name: string | number;\n  activation: boolean;\n  url: string;\n  publicPathWillBeReplacedKeyWord?: string;\n}\n\nexport default class VueIframe extends React.Component<IProps, any> {\n  private currentName: string; // 每个iframe的唯一标识\n  private isMount: boolean = false; // 是否挂载\n  private currentUrl: string = ''; // 传进来的url\n  private currentPublicPath: string = ''; // 传进来的url的协议+域名+端口\n  private publicPathKey: string = ''; // 远程源代码中要被替换的关键字\n  private publicPathReg: RegExp; // 用来替换源代码中关键字的正则\n\n  constructor(props: IProps) {\n    super(props);\n    const { url, publicPathWillBeReplacedKeyWord } = props;\n    // 获取到外部传来的url\n    this.currentUrl = url;\n    // 这个属性是用来标识要替换远程源代码中的publicPath的关键字\n    this.publicPathKey = publicPathWillBeReplacedKeyWord || '__WILL_BE_REPLACED_PUBLIC_PATH__';\n    // 这个正则会用来把远程源码中的__webpack_require__.p = 'xxxxx' 的xxxxx这个publiPath给替换掉\n    this.publicPathReg = new RegExp(this.publicPathKey, 'g');\n    // 生成每个iframe的唯一表示\n    this.currentName = String(props.name || +new Date());\n    // 获取传进来的url的协议+域名+端口\n    this.currentPublicPath = `${(\n      new RegExp(\"^https?://[\\\\w-.]+(:\\\\d+)?\", 'i').exec(this.currentUrl) || ['']\n    )[0]}/`;\n  }\n  \n  componentDidMount = () => {\n    registerApplication(\n      this.currentName, \n      (): Promise<LifeCycles<{}>> => {\n        return new Promise((resolve, reject) => {\n          axios.get(this.currentUrl).then(({ data }) => {\n            if (!data) reject('获取远程代码出现了错误');\n            // 这里由于自定义了webpack中的self\n            // 所以需要给这个self里头传递一个Vue对象\n            const internalSelf: any = { Vue };\n            /**\n             * 这里用传进来的url的origin替换掉源代码中webpack生成的publicPath\n             * 否则的话一般vue打包出来的组件的publicPath都是 '/'\n             * 直接在这里执行的话就会默认指向当前域然后会404\n             * 所以这里希望组件开发的时候将publicPath设置为一个约定好的key\n             * 这里用真正的远程路径替换\n             */\n            const codeStr = (data || '').replace(this.publicPathReg, this.currentPublicPath);\n            const originCodeFn = new Function(\"self\", codeStr);\n            originCodeFn(internalSelf);\n            const currentComponent = internalSelf[this.currentName];\n            const lifecycles = registerVueComponent(this.currentName, currentComponent);\n            resolve(lifecycles);\n          })\n        })\n      },\n      this.getBoolean,\n    );\n    if (this.props.activation) this.mount();\n  }\n\n  componentDidUpdate = () => this.props.activation ? this.mount() : this.unmount();\n\n  private getBoolean: () => boolean = () => this.isMount;\n\n  private mount = () => (this.isMount = true) && start();\n\n  private unmount = () => (this.isMount = false) || start();\n\n  render() {\n    return (\n      <div id={this.currentName}></div>\n    )\n  }\n}\n"],"names":["registerVueComponent","id","vueComponent","vueInstance","singleSpaVue","Vue","appOptions","el","render","h","attrs","bootstrap","mount","unmount","__extends","props","_super","_this","registerApplication","currentName","Promise","resolve","reject","axios","get","currentUrl","then","_a","data","internalSelf","codeStr","replace","publicPathReg","currentPublicPath","originCodeFn","Function","currentComponent","lifecycles","getBoolean","activation","isMount","start","url","publicPathWillBeReplacedKeyWord","publicPathKey","RegExp","String","name","Date","exec","VueIframe","React","Component"],"mappings":"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"}