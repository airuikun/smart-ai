{"version":3,"file":"index.js","sources":["../src/index.tsx"],"sourcesContent":["import React, { RefObject } from 'react';\nimport Vue from 'vue';\nimport { mountRootParcel, ParcelConfig } from 'single-spa';\nimport singleSpaVue from 'single-spa-vue';\n\nconst __VUE_INTERNAL_INIT__ = Vue.prototype._init;\nVue.prototype._init = function(options: any) {\n  /**\n   * TODO: 留个口儿 用来以后支持加载整个Vue应用\n   */\n  __VUE_INTERNAL_INIT__.call(this, options);\n};\n\ninterface Self {\n  Vue: typeof Vue;\n  [ propName: string ]: any;\n}\n\ninterface IProps0 {\n  cssurl?: string;\n  name?: string;\n  id?: string;\n  visible?: boolean;\n  extraProps?: { [propName: string]: any };\n  loadType?: 'xhr' | 'script';\n  instable_publicPath?: string;\n}\n\ninterface IProps1 extends IProps0 {\n  jsurl: string;\n  component?: object;\n}\n\ninterface IProps2 extends IProps0 {\n  component: object;\n  jsurl?: string; \n}\n\ntype IProps = IProps1 | IProps2;\ntype RefType = RefObject<HTMLDivElement>;\n\n\ninterface ISelecotr {\n  'getElementById': NonElementParentNode;\n  'querySelector': ParentNode;\n  'querySelectorAll': ParentNode;\n}\n\nexport default class VueIframe extends React.PureComponent<IProps, {}> {\n  private loadType: IProps['loadType']; // 加载方式 支持ajax和script标签\n  private currentName: string; // 每个iframe的name\n  private visible: boolean; // 是否显示\n  private currentUrl: string; // 传进来的url\n  private currentCSSUrl: string; // 传进来的cssurl\n  private currentPublicPath: string; // 传进来的url的协议+域名+端口\n  private publicPathKey: string; // 远程源代码中要被替换的关键字\n  private publicPathReg: RegExp; // 用来替换源代码中关键字的正则\n  private rootNodeWrapper: RefType = React.createRef<HTMLDivElement>(); // vue挂载节点是根据el再往上找它的爹\n  private component: any; // vue 组件实例\n  private parcel: any; // parcel实例\n  private vueWrapper1: HTMLDivElement = document.createElement('div'); // 挂载vue以及隐藏vue需要两个节点\n  private vueWrapper2: HTMLDivElement = document.createElement('div'); // 真正vue需要挂载的节点\n  private styleElements: HTMLLinkElement[] | HTMLStyleElement[] = []; // 用来临时存放要被添加的style标签\n\n  constructor(props: IProps) {\n    super(props);\n    const { loadType, jsurl, cssurl, component, name, visible, instable_publicPath } = props;\n    this.loadType = loadType || 'script';\n    // 初始化时候是否显示\n    this.visible = typeof visible === 'boolean' ? visible : true;\n    // 获取到外部传进来的vue组件\n    this.component = component;\n    // 获取到外部传来的url\n    this.currentUrl = jsurl || '';\n    // 获取外部传进来的css的url 可能没有\n    this.currentCSSUrl = cssurl || '';\n    // 这个属性是用来标识要替换远程源代码中的publicPath的关键字\n    this.publicPathKey = instable_publicPath || '__WILL_BE_REPLACED_PUBLIC_PATH__';\n    // 这个正则会用来把远程源码中的__webpack_require__.p = 'xxxxx' 的xxxxx这个publiPath给替换掉\n    this.publicPathReg = new RegExp(this.publicPathKey, 'g');\n    // 生成每个iframe的唯一表示\n    this.currentName = name || '';\n    // 获取传进来的url的协议+域名+端口\n    this.currentPublicPath = `${(\n      new RegExp(\"^https?://[\\\\w-.]+(:\\\\d+)?\", 'i').exec(this.currentUrl) || ['']\n    )[0]}/`;\n    // vue会挂载到这个节点2上\n    this.vueWrapper2.id = this.currentName;\n    // 初始化一些hack\n    this.initHack();\n  }\n\n  componentDidMount = async () => {\n    if (!this.currentUrl && !this.component) throw Error('组件必须接收一个url或者component属性');\n    const rootEleWrapper = this.rootNodeWrapper.current;\n    if (!rootEleWrapper) throw Error('没有vue组件的root节点');\n    /** 如果外部传了component就随机起个name */\n    (this.props.component && (this.currentName = String(+ new Date())));\n    const component = this.props.component || await this.getOriginVueComponent();\n    if (!this.isVueComponent(component)) return;\n    this.registerComponentAndMount(component);\n    this.addComponentToPage(rootEleWrapper);\n  }\n\n  componentDidUpdate = () => {\n    const { visible = true } = this.props; \n    if (visible === this.visible) return;\n    this.visible = visible;\n    const rootNodeWrapper = this.rootNodeWrapper.current;\n    if (!visible) {\n      this.vueWrapper1 = rootNodeWrapper?.removeChild(this.vueWrapper1) as HTMLDivElement;\n    } else {\n      rootNodeWrapper?.appendChild(this.vueWrapper1);\n    }\n  }\n\n  /**\n   * componentWillUnmount被调用时候不一定就是出错\n   * 但是贸然地在react项目中挂载vue组件可能出现问题\n   * 当出现问题的时候react组件会被卸载 此时会调用componentWillUnmount\n   * 这个时候应该确认下项目是否还正常运行(八成报错)\n   */\n  componentWillUnmount = () => {\n    (this.rootNodeWrapper.current as any).removeChild(this.vueWrapper1);\n    this.parcel.unmount();\n    this.parcel = null;\n    (this.internalHackSelector as Function)('getElementById', false);\n    (this.internalHackSelector as Function)('querySelector', false);\n    (this.internalHackSelector as Function)('querySelectorAll', false);\n    (this.vueWrapper1 as any) = null;\n    (this.vueWrapper2 as any) = null;\n    (this.rootNodeWrapper as any) = null;\n    (this.styleElements as any) = [];\n  }\n\n  private initHack = () => {\n    const originAppendChild = HTMLHeadElement.prototype.appendChild;\n    const s = HTMLDocument.prototype;\n    const selectorMap = {\n      'getElementById': this.initHackSelector('getElementById', s['getElementById']),\n      'querySelector': this.initHackSelector('querySelector', s['querySelector']),\n      'querySelectorAll': this.initHackSelector('querySelectorAll', s['querySelectorAll']),\n    };\n    /**\n     * 被bind过的函数的ts类型不会写...... 要死......\n     */\n    (this.internalHackCSSsandbox as Function) =\n      this.internalHackCSSsandbox.bind(this, originAppendChild);\n    (this.internalHackSelector as Function) =\n      this.internalHackSelector.bind(this, selectorMap);\n  }\n\n  /**\n   * 快被 typescript 搞死了......\n   * 有没有大佬能教教我这块儿应该怎么写ts\n   */\n  private initHackSelector = (\n    name: keyof ISelecotr,\n    originSelectorFn: ((id: string) => HTMLElement | null) |\n      (<E extends Element = Element>(id: string) => NodeListOf<E>) |\n      HTMLCollectionOf<Element>,\n  ) => {\n    return (codeIsExecuting: boolean) => {\n      const HTMLDocumentPrototype = (HTMLDocument.prototype as any);\n      if (!codeIsExecuting) HTMLDocumentPrototype[name] = originSelectorFn;\n      const _this = this;\n      HTMLDocumentPrototype[name] = function <E extends Element = Element>(id: string):\n        HTMLElement | null | NodeListOf<E> {\n        const originEl = (originSelectorFn as any).call(this, id);\n        const shadowEl = _this.vueWrapper1 &&\n          _this.vueWrapper1.shadowRoot &&\n          _this.vueWrapper1.shadowRoot[name] &&\n          typeof _this.vueWrapper1.shadowRoot[name] === 'function' &&\n          (_this.vueWrapper1.shadowRoot as any)[name](id) as HTMLElement | null | NodeListOf<E>;\n        return originEl || (shadowEl || null);\n      }\n    }\n  }\n\n  private internalHackSelector = (\n    selectorMap: { [name: string]: Function },\n    name: keyof ISelecotr,\n    codeIsExecuting: boolean,\n  ) => {\n    selectorMap[name](codeIsExecuting);\n  }\n\n  private internalHackCSSsandbox = (\n    originAppendChild: <T extends Node>(this: any, newChild: T) => T,\n    codeIsExecuting: boolean,\n  ) => {\n    /**\n     * css 沙箱基于shadow dom\n     * 如果浏览器版本不支持shadow dom的话\n     * 可以通过静态检测vue组件render方法的字符串\n     * 动态给每个节点的attrs上注入一个自定义特殊属性的方式\n     * 然后再给每个style文件的innerText的每个选择器加上属性选择\n     * TODO: 比较麻烦 以后再支持吧\n     */\n    if (!this.rootNodeWrapper.current?.attachShadow) return;\n    if (!codeIsExecuting) HTMLHeadElement.prototype.appendChild = originAppendChild;\n    const LINK_TAG_NAME = 'LINK';\n    const STYLE_TAG_NAME = 'STYLE';\n    const _this = this;\n    HTMLHeadElement.prototype.appendChild = function <T extends Node>(this: any, newChild: T) {\n      const element = newChild as any;\n      if (element.tagName) {\n        switch (element.tagName) {\n          case LINK_TAG_NAME:\n          case STYLE_TAG_NAME: {\n            _this.styleElements.push(element);\n            return originAppendChild.call(this, element.cloneNode()) as T;\n          }\n        }\n      }\n      return originAppendChild.call(this, element) as T;\n    };\n  }\n\n  private registerComponentAndMount = (component: object): void => {\n    const lifecycles = this.registerVueComponent(this.vueWrapper2, component, this.currentName);\n    this.parcel = mountRootParcel((lifecycles as ParcelConfig), { domElement: '-' });\n  }\n\n  private addComponentToPage = (rootEleWrapper: HTMLDivElement): void => {\n    /** 如果visible是false就暂时先把display置为none 之后再remove */\n    if (!this.visible) this.vueWrapper1.style.display = 'none';\n    const supportShadowDOM = !!this.vueWrapper1.attachShadow;\n    const root = supportShadowDOM ? (\n      (this.vueWrapper1.attachShadow({ mode: 'open' })) &&\n      this.vueWrapper1.shadowRoot\n    ) : this.vueWrapper1;\n    const cssurl = this.currentCSSUrl;\n    if (cssurl) {\n      const oLink = document.createElement('link');\n      oLink.rel = \"stylesheet\";\n      oLink.href = cssurl;\n      root?.appendChild(oLink);\n    }\n    this.styleElements.forEach(style => {\n      root?.appendChild(style);\n    });\n    root?.appendChild(this.vueWrapper2);\n    rootEleWrapper.appendChild(this.vueWrapper1);\n    setTimeout(() => {\n      /**\n       * 对于一上来visible就是不可见的组件\n       * 先把display置为none 然后再添加进页面\n       * 这是为了防止vue组件中可能会有类似echarts\n       * 之类的工具会通过document.querySelector等\n       * 方法选择dom\n       * 如果直接就不把vue组件添加进页面的话\n       * vue组件内部那些选择dom的方法可能会产生问题\n       */\n      if (!this.visible) {\n        this.vueWrapper1 = rootEleWrapper?.removeChild(this.vueWrapper1) as HTMLDivElement;\n      }\n      this.vueWrapper1.style.display = 'block';\n    });\n  }\n\n  private registerVueComponent = (el: string | HTMLElement, vueComponent: object, id: string) => {\n    const vueInstance = singleSpaVue({\n      Vue,\n      appOptions: {\n        el: typeof el === 'string' ? `#${el}` : el,\n        render: (h: any) => h('div', { attrs: { id } }, [h(vueComponent, {\n          props: { ...this.props.extraProps },\n        })]),\n      },\n    });\n    return ({\n      bootstrap: vueInstance.bootstrap,\n      mount: vueInstance.mount,\n      unmount: vueInstance.unmount,\n    })\n  }\n\n  private isVueComponent = (component: any): boolean => {\n    return component && typeof component === 'object' && typeof component.render === 'function';\n  }\n\n  private getOriginCode = (url: string, method: string = 'GET', data?: any): Promise<any> => {\n    return new Promise((res, rej) => {\n      const xhr: XMLHttpRequest = XMLHttpRequest ? new XMLHttpRequest() :\n        ActiveXObject ? new ActiveXObject('Microsoft.XMLHTTP') : null;\n      if (method === 'GET' && data) data && (url += `?${data}`);\n      xhr.open(method, url, true);\n      if (method == 'GET') {\n        xhr.send();\n      } else {\n        xhr.setRequestHeader('content-type', 'text/plain');\n        xhr.send((data as (Document | BodyInit | null)));\n      }\n      xhr.onreadystatechange = () => {\n        if (xhr.readyState === 4) {\n          if (xhr.status === 200) res(xhr.responseText);\n          else rej(xhr);\n        }      \n      }\n    });\n  }\n\n  private getCurrentName = (self: any): string => {\n    for (const props in self) {\n      if (!self.hasOwnProperty(props)) break;\n      if (props !== 'Vue') return props;\n    }\n    return '';\n  }\n\n  private executeOriginCode = (code: string): Self => {\n    const internalSelf: Self = { Vue };\n    const reg = this.publicPathReg;\n    const publicPath = this.currentPublicPath;\n    const url = this.currentUrl;\n    if (reg.test(code)) {\n      /**\n       * 自己开发组件的时候使用可以配置publicPath\n       * 为了让react-vue-mirco-frame支持加载静态资源\n       * 可以给publicPath设置为一个约定好的值\n       * 然后这里用传进来的origin替换掉这个约定好的值\n       * 这个约定好的值默认是 __WILL_BE_REPLACED_PUBLIC_PATH__\n       */\n      const codeStr = code.replace(reg, publicPath);\n      const originCodeFn = new Function(\"self\", codeStr);\n      originCodeFn(internalSelf);\n    } else {\n      /**\n       * 如果没有配置这个值的话 就以hack的方式注入origin\n       * webpack打包出来的umd代码里面会动态监测document.currentScript\n       * 通过临时给这个currentScript换掉的方式让webpack将origin注入进代码\n       */\n      const temporaryDocument = (window.document as any);\n      const originCurrentScript = window.document.currentScript;\n      const temporaryScript = document.createElement('script');\n      const defineProperty = Object.defineProperty;\n      temporaryScript.src = url;\n      defineProperty(temporaryDocument, 'currentScript', {\n        value: temporaryScript,\n        writable: true,\n      });\n      const originCodeFn = new Function(\"self\", code);\n      originCodeFn(internalSelf);\n      defineProperty(temporaryDocument, 'currentScript', {\n        value: originCurrentScript,\n        writable: false,\n      });\n      temporaryScript.remove && temporaryScript.remove();\n    };\n    return internalSelf;\n  } \n\n  private getOriginVueComponent = (): object => {\n    if (this.loadType === 'script') {\n      return new Promise(res => {\n        /**\n         * script标签没有defer或async的时候\n         * 下载数据以及执行都是同步的\n         */\n        (this.internalHackCSSsandbox as Function)(true);\n        (this.internalHackSelector as Function)('getElementById', true);\n        (this.internalHackSelector as Function)('querySelector', true);\n        (this.internalHackSelector as Function)('querySelectorAll', true);\n        const type = 'text/javascript';\n        const oScript1 = document.createElement('script');\n        oScript1.type = type;\n        const originSelf = window.self;\n        oScript1.innerText = 'window.self = {Vue: null}';\n        document.body.appendChild(oScript1);\n        window.self.Vue = Vue;\n        const oScript2 = document.createElement('script');\n        oScript2.type = type;\n        oScript2.src = this.currentUrl;\n        document.body.appendChild(oScript2);\n        oScript2.onload = () => {\n          (this.internalHackCSSsandbox as Function)(false);\n          const currentSelf: any = window.self;\n          (window as any).self = originSelf;\n          if (!this.currentName) (this.currentName = this.getCurrentName(currentSelf));\n          if (!this.currentName) throw Error('没有获取到vue组件');\n          this.vueWrapper2.id = this.currentName;\n          this.component = currentSelf[this.currentName];\n          oScript1.parentNode?.removeChild(oScript1);\n          oScript2.parentNode?.removeChild(oScript2);\n          res(this.component);\n        };\n      });\n    } else {\n      return new Promise(res => {\n        this.getOriginCode(this.currentUrl).then(data => {\n          /**\n           * 通过XMLHttpRequest获取源代码\n           */\n          if (!data || typeof data !== 'string') throw Error('没有加载到远程vue组件');\n          (this.internalHackCSSsandbox as Function)(true);\n          (this.internalHackSelector as Function)('getElementById', true);\n          (this.internalHackSelector as Function)('querySelector', true);\n          (this.internalHackSelector as Function)('querySelectorAll', true);\n          const internalSelf = this.executeOriginCode(data);\n          (this.internalHackCSSsandbox as Function)(false);\n          if (!this.currentName) (this.currentName = this.getCurrentName(internalSelf));\n          if (!this.currentName) throw Error('没有获取到vue组件');\n          this.vueWrapper2.id = this.currentName;\n          this.component = internalSelf[this.currentName];\n          res(this.component);\n        }).catch(err => {\n          /**\n           * 如果进入到这里说明可能请求出错了\n           */\n          console.warn('远程vue组件请求可能出现跨域或其他网络问题');\n          /**\n           * 如果出现跨域问题就强制使用script方式加载一遍\n           */\n          this.loadType = 'script';\n          res(this.getOriginVueComponent());\n        })\n      })\n    } \n  }\n\n  render = () => (<div id={this.props.id || ''} ref={this.rootNodeWrapper} />)\n}\n"],"names":["__VUE_INTERNAL_INIT__","Vue","prototype","_init","options","call","__extends","props","_super","_this_1","React","createRef","document","createElement","currentUrl","component","Error","rootEleWrapper","rootNodeWrapper","current","currentName","String","Date","_a","getOriginVueComponent","_b","isVueComponent","registerComponentAndMount","addComponentToPage","_c","visible","vueWrapper1","removeChild","appendChild","parcel","unmount","internalHackSelector","vueWrapper2","styleElements","originAppendChild","HTMLHeadElement","s","HTMLDocument","selectorMap","initHackSelector","internalHackCSSsandbox","bind","name","originSelectorFn","codeIsExecuting","HTMLDocumentPrototype","_this","id","originEl","shadowEl","shadowRoot","attachShadow","LINK_TAG_NAME","STYLE_TAG_NAME","newChild","element","tagName","push","cloneNode","lifecycles","registerVueComponent","mountRootParcel","domElement","style","display","supportShadowDOM","root","mode","cssurl","currentCSSUrl","oLink","rel","href","forEach","setTimeout","el","vueComponent","vueInstance","singleSpaVue","appOptions","render","h","attrs","extraProps","bootstrap","mount","url","method","data","Promise","res","rej","xhr","XMLHttpRequest","ActiveXObject","open","send","setRequestHeader","onreadystatechange","readyState","status","responseText","self","hasOwnProperty","code","internalSelf","reg","publicPathReg","publicPath","currentPublicPath","test","codeStr","replace","originCodeFn","Function","temporaryDocument","window","originCurrentScript","currentScript","temporaryScript","defineProperty","Object","src","value","writable","remove","loadType","type","oScript1","originSelf","innerText","body","oScript2","onload","currentSelf","getCurrentName","parentNode","getOriginCode","then","executeOriginCode","catch","err","console","warn","ref","jsurl","instable_publicPath","publicPathKey","RegExp","exec","initHack","PureComponent"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAKA,IAAMA,qBAAqB,GAAGC,GAAG,CAACC,SAAJ,CAAcC,KAA5C;;AACAF,GAAG,CAACC,SAAJ,CAAcC,KAAd,GAAsB,UAASC,OAAT;;;;EAIpBJ,qBAAqB,CAACK,IAAtB,CAA2B,IAA3B,EAAiCD,OAAjC;CAJF;;AA0CA;;;EAAuCE,4BAAA;;oBAgBrC,CAAYC,KAAZ;kBACEC,WAAA,KAAA,EAAMD,KAAN,SADF;;IAPQE,uBAAA,GAA2BC,KAAK,CAACC,SAAN,EAA3B;;IAGAF,mBAAA,GAA8BG,QAAQ,CAACC,aAAT,CAAuB,KAAvB,CAA9B;;IACAJ,mBAAA,GAA8BG,QAAQ,CAACC,aAAT,CAAuB,KAAvB,CAA9B;;IACAJ,qBAAA,GAAwD,EAAxD;;IA8BRA,yBAAA,GAAoB;;;;;;;kBACd,CAAC,KAAKK,UAAN,IAAoB,CAAC,KAAKC,SAA9B,EAAyC,MAAMC,KAAK,CAAC,0BAAD,CAAX;cACnCC,cAAc,GAAG,KAAKC,eAAL,CAAqBC,OAAtC;kBACF,CAACF,cAAL,EAAqB,MAAMD,KAAK,CAAC,gBAAD,CAAX;;;mBAEfT,KAAL,CAAWQ,SAAX,KAAyB,KAAKK,WAAL,GAAmBC,MAAM,CAAC,CAAE,IAAIC,IAAJ,EAAH,CAAlD,CAAD;cACkBC,KAAA,KAAKhB,KAAL,CAAWQ,SAAX;sBAAA;;kBAAA;;;gBAA8B,KAAKS,qBAAL,GAAN;;;mBAAAC,OAAA;;;;cAApCV,SAAS,KAAT;kBACF,CAAC,KAAKW,cAAL,CAAoBX,SAApB,CAAL,EAAqC;;eAAA;mBAChCY,yBAAL,CAA+BZ,SAA/B;mBACKa,kBAAL,CAAwBX,cAAxB;;;;;;;KATF;;IAYAR,0BAAA,GAAqB;;;UACXoB,0BAAA;UAAAC,mCAAA;UACJA,OAAO,KAAKrB,OAAI,CAACqB,OAArB,EAA8B;MAC9BrB,OAAI,CAACqB,OAAL,GAAeA,OAAf;UACMZ,eAAe,GAAGT,OAAI,CAACS,eAAL,CAAqBC,OAA7C;;UACI,CAACW,OAAL,EAAc;QACZrB,OAAI,CAACsB,WAAL,GAAmB,MAAAb,eAAA,UAAA,iBAAA,SAAA,MAAiBc,YAAYvB,OAAI,CAACsB,YAArD;OADF,MAEO;cACLb,eAAA,UAAA,iBAAA,SAAA,MAAiBe,YAAYxB,OAAI,CAACsB,YAAlC;;KARJ;;;;;;;;;IAkBAtB,4BAAA,GAAuB;MACpBA,OAAI,CAACS,eAAL,CAAqBC,OAArB,CAAqCa,WAArC,CAAiDvB,OAAI,CAACsB,WAAtD;;MACDtB,OAAI,CAACyB,MAAL,CAAYC,OAAZ;;MACA1B,OAAI,CAACyB,MAAL,GAAc,IAAd;;MACCzB,OAAI,CAAC2B,oBAAL,CAAuC,gBAAvC,EAAyD,KAAzD;;MACA3B,OAAI,CAAC2B,oBAAL,CAAuC,eAAvC,EAAwD,KAAxD;;MACA3B,OAAI,CAAC2B,oBAAL,CAAuC,kBAAvC,EAA2D,KAA3D;;MACA3B,OAAI,CAACsB,WAAL,GAA2B,IAA3B;MACAtB,OAAI,CAAC4B,WAAL,GAA2B,IAA3B;MACA5B,OAAI,CAACS,eAAL,GAA+B,IAA/B;MACAT,OAAI,CAAC6B,aAAL,GAA6B,EAA7B;KAVH;;IAaQ7B,gBAAA,GAAW;UACX8B,iBAAiB,GAAGC,eAAe,CAACtC,SAAhB,CAA0B+B,WAApD;UACMQ,CAAC,GAAGC,YAAY,CAACxC,SAAvB;UACMyC,WAAW,GAAG;0BACAlC,OAAI,CAACmC,gBAAL,CAAsB,gBAAtB,EAAwCH,CAAC,CAAC,gBAAD,CAAzC,CADA;yBAEDhC,OAAI,CAACmC,gBAAL,CAAsB,eAAtB,EAAuCH,CAAC,CAAC,eAAD,CAAxC,CAFC;4BAGEhC,OAAI,CAACmC,gBAAL,CAAsB,kBAAtB,EAA0CH,CAAC,CAAC,kBAAD,CAA3C;OAHtB;;;;;MAQChC,OAAI,CAACoC,sBAAL,GACCpC,OAAI,CAACoC,sBAAL,CAA4BC,IAA5B,CAAiCrC,OAAjC,EAAuC8B,iBAAvC,CADD;MAEA9B,OAAI,CAAC2B,oBAAL,GACC3B,OAAI,CAAC2B,oBAAL,CAA0BU,IAA1B,CAA+BrC,OAA/B,EAAqCkC,WAArC,CADD;KAbK;;;;;;;IAqBAlC,wBAAA,GAAmB,UACzBsC,IADyB,EAEzBC,gBAFyB;aAMlB,UAACC,eAAD;YACCC,qBAAqB,GAAIR,YAAY,CAACxC,SAA5C;YACI,CAAC+C,eAAL,EAAsBC,qBAAqB,CAACH,IAAD,CAArB,GAA8BC,gBAA9B;YAChBG,KAAK,GAAG1C,OAAd;;QACAyC,qBAAqB,CAACH,IAAD,CAArB,GAA8B,UAAuCK,EAAvC;cAEtBC,QAAQ,GAAIL,gBAAwB,CAAC3C,IAAzB,CAA8B,IAA9B,EAAoC+C,EAApC,CAAlB;;cACME,QAAQ,GAAGH,KAAK,CAACpB,WAAN,IACfoB,KAAK,CAACpB,WAAN,CAAkBwB,UADH,IAEfJ,KAAK,CAACpB,WAAN,CAAkBwB,UAAlB,CAA6BR,IAA7B,CAFe,IAGf,OAAOI,KAAK,CAACpB,WAAN,CAAkBwB,UAAlB,CAA6BR,IAA7B,CAAP,KAA8C,UAH/B,IAIdI,KAAK,CAACpB,WAAN,CAAkBwB,UAAlB,CAAqCR,IAArC,EAA2CK,EAA3C,CAJH;;iBAKOC,QAAQ,IAAKC,QAAQ,IAAI,IAAhC;SARF;OAJF;KANM;;IAuBA7C,4BAAA,GAAuB,UAC7BkC,WAD6B,EAE7BI,IAF6B,EAG7BE,eAH6B;MAK7BN,WAAW,CAACI,IAAD,CAAX,CAAkBE,eAAlB;KALM;;IAQAxC,8BAAA,GAAyB,UAC/B8B,iBAD+B,EAE/BU,eAF+B;;;;;;;;;;;;UAY3B,QAACxC,OAAI,CAACS,eAAL,CAAqBC,iDAASqC,YAA/B,CAAJ,EAAiD;UAC7C,CAACP,eAAL,EAAsBT,eAAe,CAACtC,SAAhB,CAA0B+B,WAA1B,GAAwCM,iBAAxC;UAChBkB,aAAa,GAAG,MAAtB;UACMC,cAAc,GAAG,OAAvB;UACMP,KAAK,GAAG1C,OAAd;;MACA+B,eAAe,CAACtC,SAAhB,CAA0B+B,WAA1B,GAAwC,UAAqC0B,QAArC;YAChCC,OAAO,GAAGD,QAAhB;;YACIC,OAAO,CAACC,OAAZ,EAAqB;kBACXD,OAAO,CAACC,OAAhB;iBACOJ,aAAL;iBACKC,cAAL;;gBACEP,KAAK,CAACb,aAAN,CAAoBwB,IAApB,CAAyBF,OAAzB;;uBACOrB,iBAAiB,CAAClC,IAAlB,CAAuB,IAAvB,EAA6BuD,OAAO,CAACG,SAAR,EAA7B,CAAP;;;;;eAICxB,iBAAiB,CAAClC,IAAlB,CAAuB,IAAvB,EAA6BuD,OAA7B,CAAP;OAXF;KAjBM;;IAgCAnD,iCAAA,GAA4B,UAACM,SAAD;UAC5BiD,UAAU,GAAGvD,OAAI,CAACwD,oBAAL,CAA0BxD,OAAI,CAAC4B,WAA/B,EAA4CtB,SAA5C,EAAuDN,OAAI,CAACW,WAA5D,CAAnB;;MACAX,OAAI,CAACyB,MAAL,GAAcgC,eAAe,CAAEF,UAAF,EAA+B;QAAEG,UAAU,EAAE;OAA7C,CAA7B;KAFM;;IAKA1D,0BAAA,GAAqB,UAACQ,cAAD;;;;;UAEvB,CAACR,OAAI,CAACqB,OAAV,EAAmBrB,OAAI,CAACsB,WAAL,CAAiBqC,KAAjB,CAAuBC,OAAvB,GAAiC,MAAjC;UACbC,gBAAgB,GAAG,CAAC,CAAC7D,OAAI,CAACsB,WAAL,CAAiByB,YAA5C;UACMe,IAAI,GAAGD,gBAAgB,GAC1B7D,OAAI,CAACsB,WAAL,CAAiByB,YAAjB,CAA8B;QAAEgB,IAAI,EAAE;OAAtC,CAAD,IACA/D,OAAI,CAACsB,WAAL,CAAiBwB,UAFU,GAGzB9C,OAAI,CAACsB,WAHT;UAIM0C,MAAM,GAAGhE,OAAI,CAACiE,aAApB;;UACID,MAAJ,EAAY;YACJE,KAAK,GAAG/D,QAAQ,CAACC,aAAT,CAAuB,MAAvB,CAAd;QACA8D,KAAK,CAACC,GAAN,GAAY,YAAZ;QACAD,KAAK,CAACE,IAAN,GAAaJ,MAAb;cACAF,IAAA,UAAA,iBAAA,SAAA,MAAMtC,YAAY0C,MAAlB;;;MAEFlE,OAAI,CAAC6B,aAAL,CAAmBwC,OAAnB,CAA2B,UAAAV,KAAA;;;cACzBG,IAAA,UAAA,iBAAA,SAAA,MAAMtC,YAAYmC,MAAlB;OADF;;YAGAG,IAAA,UAAA,iBAAA,SAAA,MAAMtC,YAAYxB,OAAI,CAAC4B,YAAvB;MACApB,cAAc,CAACgB,WAAf,CAA2BxB,OAAI,CAACsB,WAAhC;MACAgD,UAAU,CAAC;;;;;;;;;;;;;YAUL,CAACtE,OAAI,CAACqB,OAAV,EAAmB;UACjBrB,OAAI,CAACsB,WAAL,GAAmB,MAAAd,cAAA,UAAA,iBAAA,SAAA,MAAgBe,YAAYvB,OAAI,CAACsB,YAApD;;;QAEFtB,OAAI,CAACsB,WAAL,CAAiBqC,KAAjB,CAAuBC,OAAvB,GAAiC,OAAjC;OAbQ,CAAV;KApBM;;IAqCA5D,4BAAA,GAAuB,UAACuE,EAAD,EAA2BC,YAA3B,EAAiD7B,EAAjD;UACvB8B,WAAW,GAAGC,YAAY,CAAC;QAC/BlF,GAAG,KAD4B;QAE/BmF,UAAU,EAAE;UACVJ,EAAE,EAAE,OAAOA,EAAP,KAAc,QAAd,GAAyB,MAAIA,EAA7B,GAAoCA,EAD9B;UAEVK,MAAM,EAAE,gBAACC,CAAD;mBAAYA,CAAC,CAAC,KAAD,EAAQ;cAAEC,KAAK,EAAE;gBAAEnC,EAAE;;aAArB,EAA2B,CAACkC,CAAC,CAACL,YAAD,EAAe;cAC/D1E,KAAK,eAAOE,OAAI,CAACF,KAAL,CAAWiF;aADyB,CAAF,CAA3B,CAAD;;;OAJQ,CAAhC;aASQ;QACNC,SAAS,EAAEP,WAAW,CAACO,SADjB;QAENC,KAAK,EAAER,WAAW,CAACQ,KAFb;QAGNvD,OAAO,EAAE+C,WAAW,CAAC/C;OAHvB;KAVM;;IAiBA1B,sBAAA,GAAiB,UAACM,SAAD;aAChBA,SAAS,IAAI,QAAOA,SAAP,MAAqB,QAAlC,IAA8C,OAAOA,SAAS,CAACsE,MAAjB,KAA4B,UAAjF;KADM;;IAIA5E,qBAAA,GAAgB,UAACkF,GAAD,EAAcC,MAAd,EAAsCC,IAAtC;2BAAc,EAAA;QAAAD,cAAA;;;aAC7B,IAAIE,OAAJ,CAAY,UAACC,GAAD,EAAMC,GAAN;YACXC,GAAG,GAAmBC,cAAc,GAAG,IAAIA,cAAJ,EAAH,GACxCC,aAAa,GAAG,IAAIA,aAAJ,CAAkB,mBAAlB,CAAH,GAA4C,IAD3D;YAEIP,MAAM,KAAK,KAAX,IAAoBC,IAAxB,EAA8BA,IAAI,KAAKF,GAAG,IAAI,MAAIE,IAAhB,CAAJ;QAC9BI,GAAG,CAACG,IAAJ,CAASR,MAAT,EAAiBD,GAAjB,EAAsB,IAAtB;;YACIC,MAAM,IAAI,KAAd,EAAqB;UACnBK,GAAG,CAACI,IAAJ;SADF,MAEO;UACLJ,GAAG,CAACK,gBAAJ,CAAqB,cAArB,EAAqC,YAArC;UACAL,GAAG,CAACI,IAAJ,CAAUR,IAAV;;;QAEFI,GAAG,CAACM,kBAAJ,GAAyB;cACnBN,GAAG,CAACO,UAAJ,KAAmB,CAAvB,EAA0B;gBACpBP,GAAG,CAACQ,MAAJ,KAAe,GAAnB,EAAwBV,GAAG,CAACE,GAAG,CAACS,YAAL,CAAH,CAAxB,KACKV,GAAG,CAACC,GAAD,CAAH;;SAHT;OAXK,CAAP;KADM;;IAqBAxF,sBAAA,GAAiB,UAACkG,IAAD;WAClB,IAAMpG,KAAX,IAAoBoG,IAApB,EAA0B;YACpB,CAACA,IAAI,CAACC,cAAL,CAAoBrG,KAApB,CAAL,EAAiC;YAC7BA,KAAK,KAAK,KAAd,EAAqB,OAAOA,KAAP;;;aAEhB,EAAP;KALM;;IAQAE,yBAAA,GAAoB,UAACoG,IAAD;UACpBC,YAAY,GAAS;QAAE7G,GAAG;OAAhC;UACM8G,GAAG,GAAGtG,OAAI,CAACuG,aAAjB;UACMC,UAAU,GAAGxG,OAAI,CAACyG,iBAAxB;UACMvB,GAAG,GAAGlF,OAAI,CAACK,UAAjB;;UACIiG,GAAG,CAACI,IAAJ,CAASN,IAAT,CAAJ,EAAoB;;;;;;;;YAQZO,OAAO,GAAGP,IAAI,CAACQ,OAAL,CAAaN,GAAb,EAAkBE,UAAlB,CAAhB;YACMK,YAAY,GAAG,IAAIC,QAAJ,CAAa,MAAb,EAAqBH,OAArB,CAArB;QACAE,YAAY,CAACR,YAAD,CAAZ;OAVF,MAWO;;;;;;YAMCU,iBAAiB,GAAIC,MAAM,CAAC7G,QAAlC;YACM8G,mBAAmB,GAAGD,MAAM,CAAC7G,QAAP,CAAgB+G,aAA5C;YACMC,eAAe,GAAGhH,QAAQ,CAACC,aAAT,CAAuB,QAAvB,CAAxB;YACMgH,cAAc,GAAGC,MAAM,CAACD,cAA9B;QACAD,eAAe,CAACG,GAAhB,GAAsBpC,GAAtB;QACAkC,cAAc,CAACL,iBAAD,EAAoB,eAApB,EAAqC;UACjDQ,KAAK,EAAEJ,eAD0C;UAEjDK,QAAQ,EAAE;SAFE,CAAd;YAIMX,YAAY,GAAG,IAAIC,QAAJ,CAAa,MAAb,EAAqBV,IAArB,CAArB;QACAS,YAAY,CAACR,YAAD,CAAZ;QACAe,cAAc,CAACL,iBAAD,EAAoB,eAApB,EAAqC;UACjDQ,KAAK,EAAEN,mBAD0C;UAEjDO,QAAQ,EAAE;SAFE,CAAd;QAIAL,eAAe,CAACM,MAAhB,IAA0BN,eAAe,CAACM,MAAhB,EAA1B;;AAEF,aAAOpB,YAAP;KAvCM;;IA0CArG,6BAAA,GAAwB;UAC1BA,OAAI,CAAC0H,QAAL,KAAkB,QAAtB,EAAgC;eACvB,IAAIrC,OAAJ,CAAY,UAAAC,GAAA;;;;;UAKhBtF,OAAI,CAACoC,sBAAL,CAAyC,IAAzC;;UACApC,OAAI,CAAC2B,oBAAL,CAAuC,gBAAvC,EAAyD,IAAzD;;UACA3B,OAAI,CAAC2B,oBAAL,CAAuC,eAAvC,EAAwD,IAAxD;;UACA3B,OAAI,CAAC2B,oBAAL,CAAuC,kBAAvC,EAA2D,IAA3D;;cACKgG,IAAI,GAAG,iBAAb;cACMC,QAAQ,GAAGzH,QAAQ,CAACC,aAAT,CAAuB,QAAvB,CAAjB;UACAwH,QAAQ,CAACD,IAAT,GAAgBA,IAAhB;cACME,UAAU,GAAGb,MAAM,CAACd,IAA1B;UACA0B,QAAQ,CAACE,SAAT,GAAqB,2BAArB;UACA3H,QAAQ,CAAC4H,IAAT,CAAcvG,WAAd,CAA0BoG,QAA1B;UACAZ,MAAM,CAACd,IAAP,CAAY1G,GAAZ,GAAkBA,GAAlB;cACMwI,QAAQ,GAAG7H,QAAQ,CAACC,aAAT,CAAuB,QAAvB,CAAjB;UACA4H,QAAQ,CAACL,IAAT,GAAgBA,IAAhB;UACAK,QAAQ,CAACV,GAAT,GAAetH,OAAI,CAACK,UAApB;UACAF,QAAQ,CAAC4H,IAAT,CAAcvG,WAAd,CAA0BwG,QAA1B;;UACAA,QAAQ,CAACC,MAAT,GAAkB;;;YACfjI,OAAI,CAACoC,sBAAL,CAAyC,KAAzC;;gBACK8F,WAAW,GAAQlB,MAAM,CAACd,IAAhC;YACCc,MAAc,CAACd,IAAf,GAAsB2B,UAAtB;gBACG,CAAC7H,OAAI,CAACW,WAAV,EAAwBX,OAAI,CAACW,WAAL,GAAmBX,OAAI,CAACmI,cAAL,CAAoBD,WAApB,CAApB;gBACnB,CAAClI,OAAI,CAACW,WAAV,EAAuB,MAAMJ,KAAK,CAAC,YAAD,CAAX;YACvBP,OAAI,CAAC4B,WAAL,CAAiBe,EAAjB,GAAsB3C,OAAI,CAACW,WAA3B;YACAX,OAAI,CAACM,SAAL,GAAiB4H,WAAW,CAAClI,OAAI,CAACW,WAAN,CAA5B;kBACAiH,QAAQ,CAACQ,UAAT,UAAA,iBAAA,SAAA,MAAqB7G,YAAYqG,SAAjC;kBACAI,QAAQ,CAACI,UAAT,UAAA,iBAAA,SAAA,MAAqB7G,YAAYyG,SAAjC;YACA1C,GAAG,CAACtF,OAAI,CAACM,SAAN,CAAH;WAVF;SApBK,CAAP;OADF,MAkCO;eACE,IAAI+E,OAAJ,CAAY,UAAAC,GAAA;UACjBtF,OAAI,CAACqI,aAAL,CAAmBrI,OAAI,CAACK,UAAxB,EAAoCiI,IAApC,CAAyC,UAAAlD,IAAA;;;;gBAInC,CAACA,IAAD,IAAS,OAAOA,IAAP,KAAgB,QAA7B,EAAuC,MAAM7E,KAAK,CAAC,cAAD,CAAX;;YACtCP,OAAI,CAACoC,sBAAL,CAAyC,IAAzC;;YACApC,OAAI,CAAC2B,oBAAL,CAAuC,gBAAvC,EAAyD,IAAzD;;YACA3B,OAAI,CAAC2B,oBAAL,CAAuC,eAAvC,EAAwD,IAAxD;;YACA3B,OAAI,CAAC2B,oBAAL,CAAuC,kBAAvC,EAA2D,IAA3D;;gBACK0E,YAAY,GAAGrG,OAAI,CAACuI,iBAAL,CAAuBnD,IAAvB,CAArB;;YACCpF,OAAI,CAACoC,sBAAL,CAAyC,KAAzC;;gBACG,CAACpC,OAAI,CAACW,WAAV,EAAwBX,OAAI,CAACW,WAAL,GAAmBX,OAAI,CAACmI,cAAL,CAAoB9B,YAApB,CAApB;gBACnB,CAACrG,OAAI,CAACW,WAAV,EAAuB,MAAMJ,KAAK,CAAC,YAAD,CAAX;YACvBP,OAAI,CAAC4B,WAAL,CAAiBe,EAAjB,GAAsB3C,OAAI,CAACW,WAA3B;YACAX,OAAI,CAACM,SAAL,GAAiB+F,YAAY,CAACrG,OAAI,CAACW,WAAN,CAA7B;YACA2E,GAAG,CAACtF,OAAI,CAACM,SAAN,CAAH;WAfF,EAgBGkI,KAhBH,CAgBS,UAAAC,GAAA;;;;YAIPC,OAAO,CAACC,IAAR,CAAa,wBAAb;;;;;YAIA3I,OAAI,CAAC0H,QAAL,GAAgB,QAAhB;YACApC,GAAG,CAACtF,OAAI,CAACe,qBAAL,EAAD,CAAH;WAzBF;SADK,CAAP;;KApCI;;IAoERf,cAAA,GAAS;aAAOC,mBAAA,MAAA;QAAK0C,EAAE,EAAE3C,OAAI,CAACF,KAAL,CAAW6C,EAAX,IAAiB;QAAIiG,GAAG,EAAE5I,OAAI,CAACS;OAAxC,CAAD;KAAf;;QAnWUiH,yBAAA;QAAUmB,mBAAV;QAAiB7E,qBAAjB;QAAyB1D,2BAAzB;QAAoCgC,iBAApC;QAA0CjB,uBAA1C;QAAmDyH,+CAAnD;IACR9I,OAAI,CAAC0H,QAAL,GAAgBA,QAAQ,IAAI,QAA5B;;IAEA1H,OAAI,CAACqB,OAAL,GAAe,OAAOA,OAAP,KAAmB,SAAnB,GAA+BA,OAA/B,GAAyC,IAAxD;;IAEArB,OAAI,CAACM,SAAL,GAAiBA,SAAjB;;IAEAN,OAAI,CAACK,UAAL,GAAkBwI,KAAK,IAAI,EAA3B;;IAEA7I,OAAI,CAACiE,aAAL,GAAqBD,MAAM,IAAI,EAA/B;;IAEAhE,OAAI,CAAC+I,aAAL,GAAqBD,mBAAmB,IAAI,kCAA5C;;IAEA9I,OAAI,CAACuG,aAAL,GAAqB,IAAIyC,MAAJ,CAAWhJ,OAAI,CAAC+I,aAAhB,EAA+B,GAA/B,CAArB;;IAEA/I,OAAI,CAACW,WAAL,GAAmB2B,IAAI,IAAI,EAA3B;;IAEAtC,OAAI,CAACyG,iBAAL,GAA4B,CAC1B,IAAIuC,MAAJ,CAAW,4BAAX,EAAyC,GAAzC,EAA8CC,IAA9C,CAAmDjJ,OAAI,CAACK,UAAxD,KAAuE,CAAC,EAAD,CAD7C,EAE1B,CAF0B,OAA5B;;IAIAL,OAAI,CAAC4B,WAAL,CAAiBe,EAAjB,GAAsB3C,OAAI,CAACW,WAA3B;;IAEAX,OAAI,CAACkJ,QAAL;;;;;kBA6UJ;EAtXuCjJ,KAAK,CAACkJ,cAA7C;;;;"}