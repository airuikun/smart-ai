{"version":3,"file":"index.js","sources":["../../src/index.tsx"],"sourcesContent":["import React from 'react';\nimport Vue from 'vue';\nimport { mountRootParcel, ParcelConfig } from 'single-spa';\nimport singleSpaVue from 'single-spa-vue';\n\nconst __VUE_INTERNAL_INIT__ = Vue.prototype._init;\nVue.prototype._init = function(options: any) {\n  /**\n   * TODO: 留个口儿 用来以后支持加载整个Vue应用(目前只支持加载组件)\n   */\n  __VUE_INTERNAL_INIT__.call(this, options);\n};\n\ninterface IProps {\n  name: string | number;\n  url: string;\n  visible?: boolean;\n  extraProps?: { [propName: string]: any };\n  publicPathWillBeReplacedKeyWord?: string;\n}\n\nexport default class VueIframe extends React.PureComponent<IProps, any> {\n  private currentName: string; // 每个iframe的唯一标识\n  private visible: boolean; // 是否显示\n  private currentUrl: string; // 传进来的url\n  private currentPublicPath: string; // 传进来的url的协议+域名+端口\n  private publicPathKey: string; // 远程源代码中要被替换的关键字\n  private publicPathReg: RegExp; // 用来替换源代码中关键字的正则\n  private rootNodeWrapper = React.createRef<HTMLDivElement>(); // vue挂载节点是根据el再往上找它的爹\n  private component: any; // vue 组件实例\n  private parcel: any; // parcel实例\n  private vueWrapper1: HTMLDivElement = document.createElement('div'); // 挂载vue以及隐藏vue需要两个节点\n  private vueWrapper2: HTMLDivElement = document.createElement('div'); // 真正vue需要挂载的节点\n\n  constructor(props: IProps) {\n    super(props);\n    const { url, name, visible, publicPathWillBeReplacedKeyWord } = props;\n    // 初始化时候是否显示\n    this.visible = typeof visible === 'boolean' ? visible : true;\n    // 获取到外部传来的url\n    this.currentUrl = url;\n    // 这个属性是用来标识要替换远程源代码中的publicPath的关键字\n    this.publicPathKey = publicPathWillBeReplacedKeyWord || '__WILL_BE_REPLACED_PUBLIC_PATH__';\n    // 这个正则会用来把远程源码中的__webpack_require__.p = 'xxxxx' 的xxxxx这个publiPath给替换掉\n    this.publicPathReg = new RegExp(this.publicPathKey, 'g');\n    // 生成每个iframe的唯一表示\n    this.currentName = String(name || +new Date());\n    // 获取传进来的url的协议+域名+端口\n    this.currentPublicPath = `${(\n      new RegExp(\"^https?://[\\\\w-.]+(:\\\\d+)?\", 'i').exec(this.currentUrl) || ['']\n    )[0]}/`;\n    // vue会挂载到这个节点2上\n    this.vueWrapper2.id = this.currentName;\n    // 节点1是为了可以让vue随时visibility 同时使vue的根节点脱离react的fiber树\n    this.vueWrapper1.appendChild(this.vueWrapper2);\n  }\n\n  componentDidMount = async () => {\n    const component = await this.getOriginVueComponent();\n    if (component && typeof component !== 'object') return;\n    const lifecycles = this.registerVueComponent(this.vueWrapper2, component, this.currentName);\n    this.parcel = mountRootParcel((lifecycles as ParcelConfig), { domElement: '-' });\n  }\n\n  componentDidUpdate = () => {\n    const { visible = true } = this.props; \n    if (visible === this.visible) return;\n    this.visible = visible;\n    const rootNodeWrapper = this.rootNodeWrapper.current;\n    if (!visible) {\n      this.vueWrapper1 = rootNodeWrapper?.removeChild(this.vueWrapper1) as HTMLDivElement;\n    } else {\n      rootNodeWrapper?.appendChild(this.vueWrapper1);\n    }\n  }\n\n  /**\n   * componentWillUnmount被调用时候不一定就是出错\n   * 但是贸然地在react项目中挂载vue组件可能出现问题\n   * 当出现问题的时候react组件会被卸载 此时会调用componentWillUnmount\n   * 这个时候应该确认下项目是否还正常运行(八成报错)\n   */\n  componentWillUnmount = () => {\n    (this.vueWrapper1 as any) = null;\n    (this.vueWrapper2 as any) = null;\n    this.rootNodeWrapper.current?.removeChild(this.vueWrapper1);\n    this.parcel.unmount();\n  }\n\n  private registerVueComponent = (el: string | HTMLElement, vueComponent: object, id: string) => {\n    const vueInstance = singleSpaVue({\n      Vue,\n      appOptions: {\n        el: typeof el === 'string' ? `#${el}` : el,\n        render: (h: any) => h('div', { attrs: { id } }, [h(vueComponent, {\n          props: { ...this.props.extraProps }\n        })]),\n      },\n    });\n    return ({\n      bootstrap: vueInstance.bootstrap,\n      mount: vueInstance.mount,\n      unmount: vueInstance.unmount,\n    })\n  }\n\n  private getOriginCode = (url: string, method: string = 'GET', data?: any): Promise<any> => {\n    return new Promise((res, rej) => {\n      const xhr: XMLHttpRequest = XMLHttpRequest ? new XMLHttpRequest() :\n        ActiveXObject ? new ActiveXObject('Microsoft.XMLHTTP') : null;\n      if (method === 'GET' && data) data && (url += `?${data}`);\n      xhr.open(method, url, true);\n      if (method == 'GET') {\n        xhr.send();\n      } else {\n        xhr.setRequestHeader('content-type', 'text/plain');\n        xhr.send((data as (Document | BodyInit | null)));\n      }\n      xhr.onreadystatechange = () => {\n        if (xhr.readyState === 4) {\n          if (xhr.status === 200) res(xhr.responseText);\n          else rej(xhr);\n        }      \n      }\n    });\n  }\n\n  private getOriginVueComponent = (): object => {\n    return new Promise(res => {\n      this.getOriginCode(this.currentUrl).then(data => {\n        /**\n         * 先尝试直接通过XMLHttpRequest获取源代码\n         */\n        if (!data || typeof data !== 'string') throw Error('没有加载到远程vue组件');\n        const internalSelf: any = { Vue };\n        const currentName = this.currentName;\n        const rootEleWrapper = this.rootNodeWrapper.current;\n        if (!rootEleWrapper) throw Error('没有vue组件的root节点');\n        if (this.visible) rootEleWrapper.appendChild(this.vueWrapper1);\n        const codeStr = data.replace(this.publicPathReg, this.currentPublicPath);\n        const originCodeFn = new Function(\"self\", codeStr);\n        originCodeFn(internalSelf);\n        this.component = internalSelf[currentName];\n        res(this.component);\n      }).catch(err => {\n        /**\n         * 如果通过ajax获取不到的话 可能是跨域 通过创建script标签尝试获取\n         */\n        console.warn(`${this.currentName} 这个vue组件可能存在跨域或请求错误`);\n        const oScript1 = document.createElement('script');\n        oScript1.type = 'text/javascript';\n        const originSelf = window.self;\n        oScript1.innerText = 'window.self = {Vue: null}';\n        document.body.appendChild(oScript1);\n        window.self.Vue = Vue;\n        const oScript2 = document.createElement('script');\n        oScript2.type = 'text/javascript';\n        oScript2.src = this.currentUrl;\n        document.body.appendChild(oScript2);\n        oScript2.onload = () =>{\n          const currentSelf: any = window.self;\n          (window as any).self = originSelf;\n          this.component = currentSelf[this.currentName];\n          oScript1.parentNode?.removeChild(oScript1);\n          oScript2.parentNode?.removeChild(oScript2);\n          return res(this.component);\n        };\n      });\n    })    \n  }\n\n  render = () => (<div ref={this.rootNodeWrapper} />)\n}\n"],"names":["__VUE_INTERNAL_INIT__","Vue","prototype","_init","options","call","__extends","props","_super","_this","React","createRef","document","createElement","getOriginVueComponent","component","_a","lifecycles","registerVueComponent","vueWrapper2","currentName","parcel","mountRootParcel","domElement","_c","visible","rootNodeWrapper","current","vueWrapper1","removeChild","appendChild","unmount","el","vueComponent","id","vueInstance","singleSpaVue","appOptions","render","h","attrs","extraProps","bootstrap","mount","url","method","data","Promise","res","rej","xhr","XMLHttpRequest","ActiveXObject","open","send","setRequestHeader","onreadystatechange","readyState","status","responseText","getOriginCode","currentUrl","then","Error","internalSelf","rootEleWrapper","codeStr","replace","publicPathReg","currentPublicPath","originCodeFn","Function","catch","err","console","warn","oScript1","type","originSelf","window","self","innerText","body","oScript2","src","onload","currentSelf","parentNode","ref","name","publicPathWillBeReplacedKeyWord","publicPathKey","RegExp","String","Date","exec","PureComponent"],"mappings":"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"}