{"version":3,"file":"index.js","sources":["../../src/index.tsx"],"sourcesContent":["import React from 'react';\nimport Vue from 'vue';\nimport { mountRootParcel, LifeCycles, ParcelConfig } from 'single-spa';\nimport singleSpaVue from 'single-spa-vue';\nimport axios from 'axios';\n\nconst __VUE_INTERNAL_INIT__ = Vue.prototype._init;\nVue.prototype._init = function(options: any) {\n  /**\n   * TODO: 留个口儿 用来以后支持加载整个Vue应用(目前只支持加载组件)\n   */\n  __VUE_INTERNAL_INIT__.call(this, options);\n};\n\ninterface IProps {\n  name: string | number;\n  url: string;\n  visible?: boolean;\n  extraProps?: { [propName: string]: any };\n  publicPathWillBeReplacedKeyWord?: string;\n}\n\nexport default class VueIframe extends React.PureComponent<IProps, any> {\n  private currentName: string; // 每个iframe的唯一标识\n  private visible: boolean; // 是否显示\n  private currentUrl: string; // 传进来的url\n  private currentPublicPath: string; // 传进来的url的协议+域名+端口\n  private publicPathKey: string; // 远程源代码中要被替换的关键字\n  private publicPathReg: RegExp; // 用来替换源代码中关键字的正则\n  // private rootNode: HTMLDivElement = document.createElement('div'); // vue组件挂载的root\n  private rootNodeWrapper = React.createRef<HTMLDivElement>(); // vue挂载节点是根据el再往上找它的爹\n  private parcel: any;\n  private vueWrapper1: HTMLDivElement = document.createElement('div');\n  private vueWrapper2: HTMLDivElement = document.createElement('div');\n\n  constructor(props: IProps) {\n    super(props);\n    const { url, name, visible, publicPathWillBeReplacedKeyWord } = props;\n    // 初始化时候是否显示\n    this.visible = typeof visible === 'boolean' ? visible : true;\n    // 获取到外部传来的url\n    this.currentUrl = url;\n    // 这个属性是用来标识要替换远程源代码中的publicPath的关键字\n    this.publicPathKey = publicPathWillBeReplacedKeyWord || '__WILL_BE_REPLACED_PUBLIC_PATH__';\n    // 这个正则会用来把远程源码中的__webpack_require__.p = 'xxxxx' 的xxxxx这个publiPath给替换掉\n    this.publicPathReg = new RegExp(this.publicPathKey, 'g');\n    // 生成每个iframe的唯一表示\n    this.currentName = String(name || +new Date());\n    // 获取传进来的url的协议+域名+端口\n    this.currentPublicPath = `${(\n      new RegExp(\"^https?://[\\\\w-.]+(:\\\\d+)?\", 'i').exec(this.currentUrl) || ['']\n    )[0]}/`;\n    // 设置一个内部的挂载节点\n    this.vueWrapper2.id = this.currentName;\n    this.vueWrapper1.appendChild(this.vueWrapper2);\n  }\n\n  private registerVueComponent = (el: string | HTMLElement, vueComponent: Object, id: string) => {\n    const vueInstance = singleSpaVue({\n      Vue,\n      appOptions: {\n        el: typeof el === 'string' ? `#${el}` : el,\n        render: (h: any) => h('div', { attrs: { id } }, [h(vueComponent, {\n          props: { ...this.props.extraProps }\n        })]),\n      },\n    });\n    return ({\n      bootstrap: vueInstance.bootstrap,\n      mount: vueInstance.mount,\n      unmount: vueInstance.unmount,\n    })\n  }\n\n  componentDidUpdate = () => {\n    const { visible = true } = this.props; \n    if (visible === this.visible) return;\n    this.visible = visible;\n    const rootNodeWrapper = this.rootNodeWrapper.current;\n    if (!visible) {\n      this.vueWrapper1 = rootNodeWrapper?.removeChild(this.vueWrapper1) as HTMLDivElement;\n    } else {\n      rootNodeWrapper?.appendChild(this.vueWrapper1);\n    }\n  }\n\n  /**\n   * componentWillUnmount被调用时候不一定就是出错\n   * 但是贸然地在react项目中挂载vue组件可能出现问题\n   * 当出现问题的时候react组件会被卸载 此时会调用componentWillUnmount\n   * 这个时候应该确认下项目是否还正常运行(八成报错)\n   */\n  componentWillUnmount = () => {\n    (this.vueWrapper1 as any) = null;\n    (this.vueWrapper2 as any) = null;\n    this.rootNodeWrapper.current?.removeChild(this.vueWrapper1);\n    this.parcel.unmount();\n  }\n  \n  componentDidMount = () => {\n    axios.get(this.currentUrl).then(({ data }) => {\n      if (!data) throw Error('没有加载到远程vue组件');\n      const internalSelf: any = { Vue };\n      const rootEleWrapper = this.rootNodeWrapper.current;\n      if (!rootEleWrapper) throw Error('没有vue组件的root节点');\n      if (this.visible) rootEleWrapper.appendChild(this.vueWrapper1);\n      const codeStr = (data || '').replace(this.publicPathReg, this.currentPublicPath);\n      const originCodeFn = new Function(\"self\", codeStr);\n      originCodeFn(internalSelf);\n      const currentComponent = internalSelf[this.currentName];\n      const lifecycles = this.registerVueComponent(this.vueWrapper2, currentComponent, this.currentName);\n      this.parcel = mountRootParcel((lifecycles as ParcelConfig), { domElement: '-' });\n    })\n    // mountRootParcel()\n    // registerApplication(\n    //   this.currentName, \n    //   (): Promise<LifeCycles<{}>> => {\n    //     return new Promise(resolve => {\n    //       const oScript = document.createElement('script');\n    //       oScript.type = 'text/javascript';\n    //       oScript.innerText = `var self = {Vue: null}`;\n    //       document.body.appendChild(oScript);\n    //       self.Vue = Vue;\n    //       const oScript2 = document.createElement('script');\n    //       oScript2.type = 'text/javascript';\n    //       oScript2.src = this.currentUrl;\n    //       document.body.appendChild(oScript2);\n    //       oScript2.onload = () => {\n    //         const _self: any = self;\n    //         const currentComponent = _self[this.currentName];\n    //         console.log(556677, currentComponent);\n    //       }\n    //       // axios.get(this.currentUrl).then(({ data }) => {\n    //       //   if (!data) throw Error('没有加载到远程vue组件');\n    //       //   /**\n    //       //    * 这里由于自定义了webpack中的self\n    //       //    * 所以需要给这个self里头传递一个Vue对象\n    //       //    */\n    //       //   const internalSelf: any = { Vue };\n    //       //   const rootEleWrapper = this.rootNodeWrapper.current;\n    //       //   if (!rootEleWrapper) throw Error('没有vue组件的root节点');\n    //       //   /**\n    //       //    * 直接在react渲染的节点下渲染vue组件会发生严重错误\n    //       //    * 具体错误原因暂时未知\n    //       //    * 所以需要手动创建一个节点后插入\n    //       //    */\n    //       //   rootEleWrapper.appendChild(this.rootNode);\n    //       //   /**\n    //       //    * 这里用传进来的url的origin替换掉源代码中webpack生成的publicPath\n    //       //    * 否则的话一般vue打包出来的组件的publicPath都是 '/'\n    //       //    * 直接在这里执行的话就会默认指向当前域然后会404\n    //       //    * 所以这里希望组件开发的时候将publicPath设置为一个约定好的key\n    //       //    * 这里用真正的远程路径替换\n    //       //    */\n    //       //   const codeStr = (data || '').replace(this.publicPathReg, this.currentPublicPath);\n    //       //   const originCodeFn = new Function(\"self\", codeStr);\n    //       //   originCodeFn(internalSelf);\n    //       //   const currentComponent = internalSelf[this.currentName];\n    //       //   const lifecycles = this.registerVueComponent(this.currentName, currentComponent);\n    //       //   resolve(lifecycles);\n    //       // })\n    //     })\n    //   },\n    //   this.getBoolean,\n    // );\n    // if (this.props.activation) this.mount();\n  }\n\n  render = () => (<div ref={this.rootNodeWrapper} />)\n}\n"],"names":["__VUE_INTERNAL_INIT__","Vue","prototype","_init","options","call","__extends","props","_super","_this","React","createRef","document","createElement","el","vueComponent","id","vueInstance","singleSpaVue","appOptions","render","h","attrs","extraProps","bootstrap","mount","unmount","_c","visible","rootNodeWrapper","current","vueWrapper1","removeChild","appendChild","vueWrapper2","parcel","axios","get","currentUrl","then","_a","data","Error","internalSelf","rootEleWrapper","codeStr","replace","publicPathReg","currentPublicPath","originCodeFn","Function","currentComponent","currentName","lifecycles","registerVueComponent","mountRootParcel","domElement","ref","url","name","publicPathWillBeReplacedKeyWord","publicPathKey","RegExp","String","Date","exec","PureComponent"],"mappings":"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"}